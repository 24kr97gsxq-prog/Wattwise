<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>âš¡ WattWise â€” Texas Energy Savings</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>

<style>
  :root {
    --tx-amber: #F59E0B;
    --tx-orange: #EA580C;
    --tx-gold: #FCD34D;
    --tx-dark: #0C1117;
    --tx-surface: #161B24;
    --tx-card: #1E2535;
    --tx-border: #2A3347;
    --tx-muted: #4B5870;
    --tx-text: #E8EDF5;
    --tx-sub: #8A97AD;
    --tx-green: #10B981;
    --tx-red: #EF4444;
    --font-display: 'Bebas Neue', sans-serif;
    --font-body: 'DM Sans', sans-serif;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

  body {
    background: var(--tx-dark);
    color: var(--tx-text);
    font-family: var(--font-body);
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* â”€â”€ HEADER â”€â”€ */
  .header {
    background: var(--tx-surface);
    border-bottom: 1px solid var(--tx-border);
    padding: 14px 20px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    position: sticky;
    top: 0;
    z-index: 100;
  }
  .header-logo {
    font-family: var(--font-display);
    font-size: 26px;
    letter-spacing: 1px;
    color: var(--tx-amber);
    line-height: 1;
  }
  .header-logo span { color: var(--tx-text); }
  .header-badge {
    font-size: 11px;
    font-weight: 600;
    background: rgba(245,158,11,0.15);
    color: var(--tx-amber);
    border: 1px solid rgba(245,158,11,0.3);
    padding: 4px 10px;
    border-radius: 20px;
    letter-spacing: 0.5px;
  }

  /* â”€â”€ TABS â”€â”€ */
  .tabs {
    display: flex;
    background: var(--tx-surface);
    border-bottom: 1px solid var(--tx-border);
    overflow-x: auto;
    scrollbar-width: none;
  }
  .tabs::-webkit-scrollbar { display: none; }
  .tab {
    flex: 1;
    min-width: 70px;
    padding: 12px 8px 10px;
    text-align: center;
    cursor: pointer;
    font-size: 10px;
    font-weight: 600;
    color: var(--tx-muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    border-bottom: 2px solid transparent;
    transition: all 0.2s;
    white-space: nowrap;
  }
  .tab .tab-icon { font-size: 18px; display: block; margin-bottom: 3px; }
  .tab.active { color: var(--tx-amber); border-bottom-color: var(--tx-amber); }

  /* â”€â”€ PANELS â”€â”€ */
  .panel { display: none; padding: 20px; animation: fadeIn 0.25s ease; }
  .panel.active { display: block; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(6px); } to { opacity: 1; transform: none; } }

  /* â”€â”€ CARDS â”€â”€ */
  .card {
    background: var(--tx-card);
    border: 1px solid var(--tx-border);
    border-radius: 16px;
    padding: 20px;
    margin-bottom: 14px;
  }
  .card-title {
    font-family: var(--font-display);
    font-size: 18px;
    letter-spacing: 0.5px;
    color: var(--tx-amber);
    margin-bottom: 14px;
  }

  /* â”€â”€ HERO SEARCH â”€â”€ */
  .hero {
    background: linear-gradient(135deg, var(--tx-surface) 0%, #1a2035 100%);
    border: 1px solid var(--tx-border);
    border-radius: 20px;
    padding: 28px 20px;
    margin-bottom: 20px;
    text-align: center;
    position: relative;
    overflow: hidden;
  }
  .hero::before {
    content: '';
    position: absolute;
    top: -60px; right: -60px;
    width: 200px; height: 200px;
    background: radial-gradient(circle, rgba(245,158,11,0.12) 0%, transparent 70%);
    pointer-events: none;
  }
  .hero-title {
    font-family: var(--font-display);
    font-size: 42px;
    line-height: 1;
    letter-spacing: 1px;
    color: var(--tx-text);
    margin-bottom: 6px;
  }
  .hero-title span { color: var(--tx-amber); }
  .hero-sub {
    font-size: 14px;
    color: var(--tx-sub);
    margin-bottom: 22px;
    line-height: 1.5;
  }

  .zip-row {
    display: flex;
    gap: 10px;
    max-width: 340px;
    margin: 0 auto;
  }
  .zip-input {
    flex: 1;
    background: var(--tx-dark);
    border: 2px solid var(--tx-border);
    border-radius: 12px;
    padding: 14px 16px;
    font-size: 22px;
    font-family: var(--font-display);
    letter-spacing: 3px;
    color: var(--tx-text);
    text-align: center;
    outline: none;
    transition: border-color 0.2s;
  }
  .zip-input:focus { border-color: var(--tx-amber); }
  .zip-input::placeholder { color: var(--tx-muted); font-size: 16px; letter-spacing: 1px; font-family: var(--font-body); }

  /* â”€â”€ BUTTONS â”€â”€ */
  .btn {
    padding: 14px 22px;
    border-radius: 12px;
    font-weight: 700;
    font-size: 15px;
    cursor: pointer;
    border: none;
    transition: all 0.15s;
    display: inline-flex;
    align-items: center;
    gap: 7px;
  }
  .btn:active { transform: scale(0.96); }
  .btn-primary {
    background: linear-gradient(135deg, var(--tx-amber), var(--tx-orange));
    color: white;
    box-shadow: 0 4px 20px rgba(245,158,11,0.3);
  }
  .btn-primary:hover { box-shadow: 0 4px 28px rgba(245,158,11,0.45); }
  .btn-outline {
    background: transparent;
    border: 1.5px solid var(--tx-border);
    color: var(--tx-sub);
  }
  .btn-outline:hover { border-color: var(--tx-amber); color: var(--tx-amber); }
  .btn-sm { padding: 9px 16px; font-size: 13px; border-radius: 10px; }
  .btn-green { background: var(--tx-green); color: white; }

  /* â”€â”€ SAVINGS REVEAL â”€â”€ */
  #savings-result { display: none; }
  .savings-number {
    font-family: var(--font-display);
    font-size: 80px;
    line-height: 1;
    color: var(--tx-gold);
    letter-spacing: 2px;
  }
  .savings-label {
    font-size: 13px;
    color: var(--tx-sub);
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-top: 4px;
  }
  .rate-comparison {
    display: flex;
    justify-content: center;
    gap: 20px;
    margin: 16px 0;
  }
  .rate-pill {
    background: var(--tx-dark);
    border-radius: 10px;
    padding: 10px 16px;
    text-align: center;
  }
  .rate-pill .val {
    font-family: var(--font-display);
    font-size: 26px;
    line-height: 1;
  }
  .rate-pill .lbl { font-size: 11px; color: var(--tx-sub); margin-top: 2px; }
  .rate-pill.good .val { color: var(--tx-green); }
  .rate-pill.bad  .val { color: var(--tx-red); }

  /* â”€â”€ PLAN CARDS â”€â”€ */
  .plan-card {
    background: var(--tx-dark);
    border: 1px solid var(--tx-border);
    border-radius: 14px;
    padding: 16px;
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    gap: 14px;
    transition: border-color 0.2s;
  }
  .plan-card:hover { border-color: var(--tx-amber); }
  .plan-rank {
    width: 36px; height: 36px;
    border-radius: 10px;
    background: var(--tx-surface);
    display: flex; align-items: center; justify-content: center;
    font-family: var(--font-display);
    font-size: 20px;
    color: var(--tx-sub);
    flex-shrink: 0;
  }
  .plan-rank.gold { background: rgba(245,158,11,0.2); color: var(--tx-amber); }
  .plan-info { flex: 1; min-width: 0; }
  .plan-provider { font-size: 11px; color: var(--tx-sub); }
  .plan-name { font-weight: 600; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .plan-tags { display: flex; gap: 5px; margin-top: 5px; flex-wrap: wrap; }
  .tag {
    font-size: 10px;
    font-weight: 600;
    padding: 2px 8px;
    border-radius: 20px;
    background: rgba(255,255,255,0.06);
    color: var(--tx-sub);
  }
  .tag.green { background: rgba(16,185,129,0.15); color: var(--tx-green); }
  .plan-rate-col { text-align: right; flex-shrink: 0; }
  .plan-rate {
    font-family: var(--font-display);
    font-size: 30px;
    color: var(--tx-gold);
    line-height: 1;
  }
  .plan-rate-sub { font-size: 11px; color: var(--tx-sub); }
  .efl-link {
    font-size: 11px;
    color: #60A5FA;
    text-decoration: none;
    margin-top: 4px;
    display: block;
  }
  .efl-link:hover { text-decoration: underline; }

  /* â”€â”€ SEARCHING OVERLAY â”€â”€ */
  #searching-overlay {
    display: none;
    text-align: center;
    padding: 40px 20px;
  }
  .spinner {
    width: 52px; height: 52px;
    border-radius: 50%;
    border: 4px solid var(--tx-border);
    border-top-color: var(--tx-amber);
    animation: spin 0.8s linear infinite;
    margin: 0 auto 20px;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  .searching-text {
    font-family: var(--font-display);
    font-size: 22px;
    color: var(--tx-amber);
    letter-spacing: 1px;
    animation: pulse 1.4s ease-in-out infinite;
  }
  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.5} }
  .searching-sub { font-size: 13px; color: var(--tx-sub); margin-top: 6px; }

  /* â”€â”€ COFFEE TIP JAR â”€â”€ */
  #tip-jar {
    display: none;
    background: linear-gradient(135deg, #1a1208, #201508);
    border: 1px solid rgba(245,158,11,0.35);
    border-radius: 20px;
    overflow: hidden;
    margin-top: 20px;
    animation: slideUp 0.5s cubic-bezier(0.175,0.885,0.32,1.275);
  }
  @keyframes slideUp { from { opacity:0; transform:translateY(30px) scale(0.95); } to { opacity:1; transform:none; } }
  .tip-header {
    background: linear-gradient(90deg, var(--tx-orange), #b45309);
    padding: 16px 20px;
  }
  .tip-header-top { font-size: 11px; color: rgba(255,220,150,0.7); font-weight: 600; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 3px; }
  .tip-header-title { font-family: var(--font-display); font-size: 24px; color: white; letter-spacing: 0.5px; }
  .tip-body { padding: 18px 20px; }
  .tip-copy { font-size: 14px; color: #C4A46B; line-height: 1.6; margin-bottom: 16px; }
  .tip-copy strong { color: var(--tx-gold); }
  .tip-tiers { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 16px; }
  .tier-btn {
    background: rgba(0,0,0,0.4);
    border: 1.5px solid rgba(245,158,11,0.25);
    border-radius: 14px;
    padding: 14px 8px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
  }
  .tier-btn:hover { border-color: var(--tx-amber); background: rgba(245,158,11,0.08); }
  .tier-btn:active { transform: scale(0.95); }
  .tier-btn.popular { border-color: var(--tx-amber); }
  .tier-popular-badge {
    position: absolute;
    top: -9px; left: 50%; transform: translateX(-50%);
    background: var(--tx-amber);
    color: #000;
    font-size: 9px;
    font-weight: 800;
    padding: 2px 8px;
    border-radius: 20px;
    white-space: nowrap;
  }
  .tier-emoji { font-size: 26px; display: block; margin-bottom: 6px; }
  .tier-amount { font-family: var(--font-display); font-size: 24px; color: var(--tx-gold); line-height: 1; }
  .tier-label { font-size: 11px; color: var(--tx-sub); margin-top: 3px; line-height: 1.3; }
  .tip-dismiss { text-align: center; }
  .tip-dismiss button {
    background: none; border: none; font-size: 12px; color: var(--tx-muted);
    cursor: pointer; text-decoration: underline;
  }

  /* â”€â”€ THANK YOU STATE â”€â”€ */
  #tip-thanks {
    display: none;
    background: linear-gradient(135deg, #0a1f14, #0d2818);
    border: 1px solid rgba(16,185,129,0.3);
    border-radius: 20px;
    padding: 30px 20px;
    text-align: center;
    margin-top: 20px;
    animation: slideUp 0.4s ease;
  }
  .thanks-emoji { font-size: 52px; display: block; margin-bottom: 12px; animation: bounce 0.5s ease 0.1s; }
  @keyframes bounce { 0%,100%{transform:scale(1)} 40%{transform:scale(1.25)} }
  .thanks-title { font-family: var(--font-display); font-size: 28px; color: var(--tx-green); margin-bottom: 8px; }
  .thanks-sub { font-size: 14px; color: #6EE7B7; line-height: 1.6; }

  /* â”€â”€ HISTORY TABLE â”€â”€ */
  .rate-table { width: 100%; border-collapse: collapse; }
  .rate-table th {
    font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px;
    color: var(--tx-sub); text-align: left; padding: 8px 12px;
    border-bottom: 1px solid var(--tx-border);
  }
  .rate-table td {
    padding: 12px 12px; font-size: 14px;
    border-bottom: 1px solid rgba(42,51,71,0.5);
  }
  .rate-table tr:last-child td { border-bottom: none; }
  .rate-table .rate-val { font-family: var(--font-display); font-size: 18px; color: var(--tx-gold); }

  /* â”€â”€ SETTINGS â”€â”€ */
  .setting-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 14px 0;
    border-bottom: 1px solid var(--tx-border);
  }
  .setting-row:last-child { border-bottom: none; }
  .setting-label { font-size: 14px; font-weight: 500; }
  .setting-sub { font-size: 12px; color: var(--tx-sub); margin-top: 2px; }
  .input-field {
    background: var(--tx-dark);
    border: 1.5px solid var(--tx-border);
    border-radius: 10px;
    padding: 10px 14px;
    font-size: 14px;
    color: var(--tx-text);
    width: 100%;
    outline: none;
    font-family: var(--font-body);
    transition: border-color 0.2s;
  }
  .input-field:focus { border-color: var(--tx-amber); }
  .input-group { margin-bottom: 12px; }
  .input-label { font-size: 12px; color: var(--tx-sub); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 5px; display: block; }

  /* â”€â”€ TOAST â”€â”€ */
  #toast {
    position: fixed;
    bottom: 80px; left: 50%; transform: translateX(-50%);
    background: var(--tx-card);
    border: 1px solid var(--tx-border);
    border-radius: 12px;
    padding: 12px 20px;
    font-size: 14px;
    font-weight: 500;
    z-index: 999;
    opacity: 0;
    transition: opacity 0.3s;
    pointer-events: none;
    white-space: nowrap;
  }
  #toast.show { opacity: 1; }

  /* â”€â”€ STATUS DOT â”€â”€ */
  .status-dot { display: inline-block; width: 7px; height: 7px; border-radius: 50%; margin-right: 5px; }
  .status-dot.online { background: var(--tx-green); box-shadow: 0 0 6px var(--tx-green); }
  .status-dot.offline { background: var(--tx-red); }

  /* â”€â”€ MISC â”€â”€ */
  .section-title { font-family: var(--font-display); font-size: 16px; letter-spacing: 0.5px; color: var(--tx-sub); text-transform: uppercase; margin-bottom: 12px; margin-top: 6px; }
  .empty-state { text-align: center; padding: 40px 20px; color: var(--tx-muted); }
  .empty-state .icon { font-size: 40px; margin-bottom: 12px; display: block; }
  .divider { border: none; border-top: 1px solid var(--tx-border); margin: 16px 0; }
  .flex-row { display: flex; align-items: center; gap: 10px; }
  .flex-between { display: flex; align-items: center; justify-content: space-between; }
  .text-amber { color: var(--tx-amber); }
  .text-green { color: var(--tx-green); }
  .text-red { color: var(--tx-red); }
  .text-sub { color: var(--tx-sub); font-size: 13px; }
  .mt-1 { margin-top: 4px; }
  .mt-2 { margin-top: 10px; }
  .mt-3 { margin-top: 16px; }
  .bold { font-weight: 700; }

  /* â”€â”€ POLR BANNER â”€â”€ */
  .polr-banner {
    background: rgba(239,68,68,0.1);
    border: 1px solid rgba(239,68,68,0.25);
    border-radius: 12px;
    padding: 12px 16px;
    margin-bottom: 16px;
    font-size: 13px;
    color: #FCA5A5;
    line-height: 1.5;
  }

  /* mobile bottom padding for fixed nav */
  .panel { padding-bottom: 80px; }

  @media (max-width: 360px) {
    .savings-number { font-size: 64px; }
    .tip-tiers { gap: 7px; }
  }
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â• HEADER â•â•â•â•â•â•â• -->
<div class="header">
  <div class="header-logo">âš¡ WATT<span>WISE</span></div>
  <div class="header-badge">
    <span class="status-dot online" id="status-dot"></span>
    <span id="status-text">Texas Live</span>
  </div>
</div>

<!-- â•â•â•â•â•â•â• TABS â•â•â•â•â•â•â• -->
<div class="tabs">
  <div class="tab active" onclick="switchTab('search')">
    <span class="tab-icon">ğŸ”</span>Search
  </div>
  <div class="tab" onclick="switchTab('history')">
    <span class="tab-icon">ğŸ“Š</span>History
  </div>
  <div class="tab" onclick="switchTab('alerts')">
    <span class="tab-icon">ğŸ””</span>Alerts
  </div>
  <div class="tab" onclick="switchTab('about')">
    <span class="tab-icon">â˜•</span>About
  </div>
  <div class="tab" onclick="switchTab('settings')">
    <span class="tab-icon">âš™ï¸</span>Settings
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     PANEL 1 â€” SEARCH
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="panel active" id="panel-search">

  <!-- Hero ZIP Entry -->
  <div class="hero">
    <div class="hero-title">FIND YOUR<br><span>SAVINGS</span></div>
    <div class="hero-sub">Compare every Texas energy plan by ZIP code.<br>No email. No ads. No kickbacks.</div>
    <div class="zip-row">
      <input type="tel" class="zip-input" id="zip-input" maxlength="5" placeholder="ZIP CODE"
        oninput="this.value=this.value.replace(/\D/g,'')"
        onkeydown="if(event.key==='Enter')runSearch()">
      <button class="btn btn-primary" onclick="runSearch()">âš¡ Go</button>
    </div>
    <!-- Searching state -->
    <div id="searching-overlay">
      <div class="spinner"></div>
      <div class="searching-text" id="searching-zip-label">Scanning 75024â€¦</div>
      <div class="searching-sub" id="searching-count">Comparing 0 plans from all providers</div>
    </div>
  </div>

  <!-- Results -->
  <div id="savings-result">

    <!-- POLR Warning Banner -->
    <div class="polr-banner" id="polr-banner">
      âš ï¸ The default utility rate in your area is <strong id="polr-rate-label">14.2Â¢/kWh</strong>. Most people are on this rate and don't know it.
    </div>

    <!-- Big savings number -->
    <div class="card" style="text-align:center; padding: 24px 20px;">
      <div class="text-sub" style="text-transform:uppercase;letter-spacing:1px;margin-bottom:4px">You could be overpaying</div>
      <div class="savings-number" id="savings-number">$580</div>
      <div class="savings-label">per year Â· based on 1,000 kWh/mo</div>
      <div class="rate-comparison">
        <div class="rate-pill good">
          <div class="val" id="best-rate-label">9.4Â¢</div>
          <div class="lbl">Best Rate</div>
        </div>
        <div style="align-self:center;color:var(--tx-muted);font-size:20px;">â†’</div>
        <div class="rate-pill bad">
          <div class="val" id="your-rate-label">14.2Â¢</div>
          <div class="lbl">Your Rate</div>
        </div>
      </div>
      <div class="text-sub mt-1" id="savings-location-label">ZIP 75024 Â· Plano, TX Â· Oncor territory</div>
    </div>

    <!-- Top 3 Plans -->
    <div class="section-title">âš¡ Top Plans Available Now</div>
    <div id="plan-cards-container"></div>

    <!-- Coffee Tip Jar -->
    <div id="tip-jar">
      <div class="tip-header">
        <div class="tip-header-top">â˜• Ad-Free Â· No Kickbacks Â· Solo Developer</div>
        <div class="tip-header-title">Keep WattWise Running?</div>
      </div>
      <div class="tip-body">
        <div class="tip-copy">
          I'm a neighbor who built this because I was tired of watching Texans overpay.
          I take <strong>zero money from energy companies</strong> and run zero ads.
          If I just found you <strong id="tip-savings-amount">$580 in savings</strong>,
          consider buying me a coffee to keep the servers on. â˜•
        </div>
        <div class="tip-tiers">
          <div class="tier-btn" onclick="handleTip('small_drip', 3)">
            <span class="tier-emoji">â˜•</span>
            <div class="tier-amount">$3</div>
            <div class="tier-label">Small Drip</div>
          </div>
          <div class="tier-btn popular" onclick="handleTip('coffee_pastry', 7)">
            <div class="tier-popular-badge">â­ Popular</div>
            <span class="tier-emoji">ğŸ¥</span>
            <div class="tier-amount">$7</div>
            <div class="tier-label">Coffee &amp; Pastry</div>
          </div>
          <div class="tier-btn" onclick="handleTip('energy_hero', 15)">
            <span class="tier-emoji">âš¡</span>
            <div class="tier-amount">$15</div>
            <div class="tier-label">Energy Hero</div>
          </div>
        </div>
        <div class="tip-dismiss">
          <button onclick="dismissTip()">No thanks, I'll keep overpaying</button>
        </div>
      </div>
    </div>

    <!-- Thank you state -->
    <div id="tip-thanks">
      <span class="thanks-emoji">ğŸ™Œ</span>
      <div class="thanks-title">You're a Texas Legend.</div>
      <div class="thanks-sub" id="thanks-message">
        Thank you â€” that covers one week of server time and keeps this tool free for every neighbor in Texas.
      </div>
      <button class="btn btn-outline btn-sm mt-3" onclick="document.getElementById('tip-thanks').style.display='none'">Close</button>
    </div>

  </div><!-- /savings-result -->

</div><!-- /panel-search -->

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     PANEL 2 â€” HISTORY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="panel" id="panel-history">
  <div class="section-title">ğŸ“ˆ Rate History</div>

  <div class="card">
    <div class="flex-between" style="margin-bottom:14px">
      <div>
        <div class="bold" id="history-zip-label">No ZIP searched yet</div>
        <div class="text-sub">30-day rate trend</div>
      </div>
      <button class="btn btn-outline btn-sm" onclick="switchTab('search')">Search ZIP</button>
    </div>
    <div id="history-content">
      <div class="empty-state">
        <span class="icon">ğŸ“Š</span>
        Search a ZIP to see its rate history
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-title">ğŸ—‚ Saved ZIPs</div>
    <div id="saved-zips-list">
      <div class="empty-state" style="padding:20px 0">
        <span style="color:var(--tx-sub);font-size:13px">Your searched ZIPs appear here</span>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     PANEL 3 â€” ALERTS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="panel" id="panel-alerts">
  <div class="section-title">ğŸ”” Rate Alerts</div>

  <div class="card">
    <div class="card-title">Create an Alert</div>
    <div class="input-group">
      <label class="input-label">ZIP Code</label>
      <input type="tel" class="input-field" id="alert-zip" maxlength="5" placeholder="75024" oninput="this.value=this.value.replace(/\D/g,'')">
    </div>
    <div class="input-group">
      <label class="input-label">Alert me when rates drop below (Â¢/kWh)</label>
      <input type="number" class="input-field" id="alert-threshold" placeholder="10.0" step="0.1" min="5" max="25">
    </div>
    <div class="input-group">
      <label class="input-label">Your Email</label>
      <input type="email" class="input-field" id="alert-email" placeholder="you@example.com">
    </div>
    <button class="btn btn-primary mt-2" style="width:100%" onclick="saveAlert()">ğŸ”” Set Alert</button>
  </div>

  <div class="card">
    <div class="card-title">Active Alerts</div>
    <div id="alerts-list">
      <div class="empty-state" style="padding:10px 0">
        <span class="text-sub">No alerts set yet</span>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     PANEL 4 â€” ABOUT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="panel" id="panel-about">
  <div class="hero" style="text-align:left;padding:24px 20px;margin-bottom:20px">
    <div style="font-size:40px;margin-bottom:10px">â˜•</div>
    <div class="hero-title" style="font-size:32px">THE COFFEE<br><span>FUND</span></div>
    <div class="hero-sub" style="margin-bottom:0">
      WattWise is a free tool built by a solo developer in Texas.
      No ads, no affiliate links, no sponsored plans.
    </div>
  </div>

  <div class="card">
    <div class="card-title">How This Works</div>
    <p style="font-size:14px;color:var(--tx-sub);line-height:1.7">
      Every morning, WattWise pulls the latest rates from
      <strong style="color:var(--tx-text)">PowerToChoose.org</strong> â€” the official Texas
      PUC comparison site â€” and stores them by ZIP code. When you search,
      you're seeing today's actual available rates, ranked by real effective price
      at 1,000 kWh/month (not teaser rates).
    </p>
    <hr class="divider">
    <p style="font-size:14px;color:var(--tx-sub);line-height:1.7">
      I compare those rates against your TDU's
      <strong style="color:var(--tx-text)">POLR (Provider of Last Resort)</strong> rate â€”
      the default rate you end up on if you've never switched, or when your contract expires.
      That's where the savings number comes from.
    </p>
    <hr class="divider">
    <p style="font-size:14px;color:var(--tx-sub);line-height:1.7">
      The <strong style="color:var(--tx-amber)">EFL (Electricity Facts Label)</strong> linked
      on each plan is the official PUC document showing the real price breakdown.
      Always read the EFL before you switch.
    </p>
  </div>

  <div class="card" style="background:linear-gradient(135deg,#1a1208,#1c1508);border-color:rgba(245,158,11,0.2)">
    <div class="card-title">Support This Tool</div>
    <p style="font-size:14px;color:#C4A46B;line-height:1.7;margin-bottom:16px">
      If WattWise saved you money, consider buying me a coffee.
      It's completely voluntary â€” the site will always be free.
    </p>
    <div class="tip-tiers">
      <div class="tier-btn" onclick="handleTip('small_drip', 3)">
        <span class="tier-emoji">â˜•</span>
        <div class="tier-amount">$3</div>
        <div class="tier-label">Small Drip</div>
      </div>
      <div class="tier-btn popular" onclick="handleTip('coffee_pastry', 7)">
        <div class="tier-popular-badge">â­ Popular</div>
        <span class="tier-emoji">ğŸ¥</span>
        <div class="tier-amount">$7</div>
        <div class="tier-label">Coffee &amp; Pastry</div>
      </div>
      <div class="tier-btn" onclick="handleTip('energy_hero', 15)">
        <span class="tier-emoji">âš¡</span>
        <div class="tier-amount">$15</div>
        <div class="tier-label">Energy Hero</div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-title">Share WattWise</div>
    <p style="font-size:13px;color:var(--tx-sub);margin-bottom:14px;line-height:1.6">
      Post this in your neighborhood Facebook group or Nextdoor â€” your neighbors will thank you.
    </p>
    <button class="btn btn-outline" style="width:100%;justify-content:center;margin-bottom:10px" onclick="shareNeighborhood()">
      ğŸ“£ Share to Nextdoor / Facebook
    </button>
    <button class="btn btn-outline" style="width:100%;justify-content:center" onclick="copyShareText()">
      ğŸ“‹ Copy Neighborly Message
    </button>
  </div>

  <div style="text-align:center;padding:10px 0;color:var(--tx-muted);font-size:12px">
    WattWise v1.0 Â· Not affiliated with any energy company<br>
    Data from PowerToChoose.org Â· PUC-regulated rates
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     PANEL 5 â€” SETTINGS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="panel" id="panel-settings">
  <div class="section-title">âš™ï¸ Configuration</div>

  <div class="card">
    <div class="card-title">â˜ï¸ Supabase Connection</div>
    <div class="input-group">
      <label class="input-label">Project URL</label>
      <input type="text" class="input-field" id="sb-url" placeholder="https://xxxx.supabase.co">
    </div>
    <div class="input-group">
      <label class="input-label">Anon Key</label>
      <input type="password" class="input-field" id="sb-key" placeholder="eyJh...">
    </div>
    <button class="btn btn-primary btn-sm mt-2" onclick="saveSupabase()">ğŸ’¾ Save &amp; Connect</button>
    <div class="mt-2 text-sub" id="sb-status">Not connected</div>
  </div>

  <div class="card">
    <div class="card-title">âš™ï¸ Preferences</div>
    <div class="setting-row">
      <div>
        <div class="setting-label">Monthly Usage (kWh)</div>
        <div class="setting-sub">Used to calculate your savings estimate</div>
      </div>
      <input type="number" class="input-field" style="width:90px;text-align:center" id="pref-usage" value="1000" min="200" max="5000" step="100">
    </div>
    <div class="setting-row">
      <div>
        <div class="setting-label">Default ZIP</div>
        <div class="setting-sub">Pre-fill on app open</div>
      </div>
      <input type="tel" class="input-field" style="width:90px;text-align:center" id="pref-zip" maxlength="5" placeholder="75024" oninput="this.value=this.value.replace(/\D/g,'')">
    </div>
    <button class="btn btn-primary btn-sm mt-3" onclick="savePrefs()">ğŸ’¾ Save Preferences</button>
  </div>

  <div class="card">
    <div class="card-title">ğŸ’¾ Data Management</div>
    <button class="btn btn-outline" style="width:100%;justify-content:center;margin-bottom:10px" onclick="exportData()">ğŸ“¤ Export My Data (JSON)</button>
    <button class="btn btn-outline" style="width:100%;justify-content:center;color:var(--tx-red);border-color:rgba(239,68,68,0.3)" onclick="clearData()">ğŸ—‘ï¸ Clear Local Data</button>
  </div>

  <div style="text-align:center;padding:10px;color:var(--tx-muted);font-size:11px">
    âš¡ WattWise Â· Texas Deregulated Energy Market<br>
    Data sourced from PowerToChoose.org
  </div>
</div>

<!-- â•â•â•â•â•â•â• TOAST â•â•â•â•â•â•â• -->
<div id="toast"></div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     JAVASCRIPT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script>

// â”€â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const APP = {
  supabase:    null,
  currentZip:  null,
  currentData: null,
  prefs: {
    usage: 1000,
    defaultZip: '',
  },
  savedZips: [],
  alerts: [],
  tips: [],
};

// â”€â”€â”€ SUPABASE INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initSupabase() {
  const url = localStorage.getItem('ww_sb_url');
  const key = localStorage.getItem('ww_sb_key');
  if (url && key) {
    try {
      APP.supabase = supabase.createClient(url, key);
      document.getElementById('sb-url').value = url;
      document.getElementById('sb-key').value = key;
      document.getElementById('sb-status').textContent = 'âœ… Connected';
      document.getElementById('sb-status').style.color = 'var(--tx-green)';
    } catch(e) {
      console.warn('Supabase init failed', e);
    }
  }
}

function saveSupabase() {
  const url = document.getElementById('sb-url').value.trim();
  const key = document.getElementById('sb-key').value.trim();
  if (!url || !key) { showToast('âš ï¸ Enter both URL and key'); return; }
  localStorage.setItem('ww_sb_url', url);
  localStorage.setItem('ww_sb_key', key);
  APP.supabase = supabase.createClient(url, key);
  document.getElementById('sb-status').textContent = 'âœ… Connected';
  document.getElementById('sb-status').style.color = 'var(--tx-green)';
  showToast('âœ… Supabase connected!');
}

// â”€â”€â”€ TAB SWITCHING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchTab(name) {
  document.querySelectorAll('.tab').forEach((t,i) => {
    const names = ['search','history','alerts','about','settings'];
    t.classList.toggle('active', names[i] === name);
  });
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  document.getElementById('panel-' + name).classList.add('active');
}

// â”€â”€â”€ TEXAS ZIP DATA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// TDU lookup by ZIP prefix (simplified â€” real app queries DB)
const ZIP_TDU = {
  '750':'Oncor','751':'Oncor','752':'Oncor','753':'Oncor','754':'Oncor',
  '755':'Oncor','756':'Oncor','757':'Oncor','758':'Oncor','759':'Oncor',
  '760':'Oncor','761':'Oncor','762':'Oncor','763':'Oncor','764':'Oncor',
  '765':'Oncor','766':'Oncor','767':'Oncor','768':'Oncor','769':'Oncor',
  '770':'CenterPoint','771':'CenterPoint','772':'CenterPoint','773':'CenterPoint','774':'CenterPoint',
  '775':'CenterPoint','776':'CenterPoint','777':'CenterPoint','778':'CenterPoint','779':'CenterPoint',
  '786':'AEP Texas','787':'AEP Texas','788':'AEP Texas','789':'AEP Texas',
  '780':'AEP Texas','781':'AEP Texas','782':'AEP Texas','783':'AEP Texas','784':'AEP Texas','785':'AEP Texas',
  '790':'AEP Texas','791':'AEP Texas','792':'AEP Texas','793':'AEP Texas','794':'AEP Texas','795':'AEP Texas',
  '796':'AEP Texas','797':'AEP Texas','798':'AEP Texas','799':'AEP Texas',
};

const POLR_RATES = { 'Oncor': 14.2, 'CenterPoint': 13.8, 'AEP Texas': 15.1, 'TNMP': 14.6 };

const CITY_NAMES = {
  '750': 'Dallas', '751': 'Dallas', '752': 'Dallas', '753': 'Dallas',
  '754': 'Corsicana', '755': 'Palestine', '756': 'Longview', '757': 'Tyler',
  '758': 'Palestine', '759': 'Lufkin', '760': 'Fort Worth', '761': 'Fort Worth',
  '762': 'Weatherford', '763': 'Waco', '764': 'Waco', '765': 'Waco',
  '766': 'Waco', '767': 'Dallas', '768': 'Abilene', '769': 'Midland',
  '770': 'Houston', '771': 'Houston', '772': 'Houston', '773': 'Houston',
  '774': 'Houston', '775': 'Houston', '776': 'Beaumont', '777': 'Beaumont',
  '778': 'Bryan', '779': 'Victoria', '780': 'San Antonio', '781': 'San Antonio',
  '782': 'San Antonio', '783': 'Corpus Christi', '784': 'Corpus Christi',
  '785': 'McAllen', '786': 'Austin', '787': 'Austin', '788': 'Del Rio',
  '789': 'Uvalde', '790': 'Amarillo', '791': 'Amarillo', '792': 'Childress',
  '793': 'Lubbock', '794': 'Lubbock', '795': 'Abilene', '796': 'Abilene',
  '797': 'Midland', '798': 'El Paso', '799': 'El Paso',
};

function getTDU(zip) {
  return ZIP_TDU[zip.substring(0,3)] || 'Oncor';
}
function getCity(zip) {
  return CITY_NAMES[zip.substring(0,3)] || 'Texas';
}

// â”€â”€â”€ MOCK PLAN GENERATOR (replace with real Supabase query) â”€â”€
function generateMockPlans(zip, bestRate) {
  const tdu = getTDU(zip);
  const providers = [
    { name: 'Gexa Energy',     slug: 'gexa'     },
    { name: '4Change Energy',  slug: '4change'  },
    { name: 'Pulse Power',     slug: 'pulse'    },
    { name: 'Cirro Energy',    slug: 'cirro'    },
    { name: 'TXU Energy',      slug: 'txu'      },
    { name: 'Reliant Energy',  slug: 'reliant'  },
  ];
  const plans = [
    ['Eco Saver 12',   12, true,  bestRate],
    ['Simply Low 12',  12, true,  bestRate + 0.4],
    ['Fixed Saver 12', 12, false, bestRate + 0.7],
  ];
  return plans.map((p, i) => ({
    rank:       i + 1,
    provider:   providers[i].name,
    name:       p[0],
    term:       p[1],
    green:      p[2],
    rate:       p[3].toFixed(1),
    cancel_fee: i === 0 ? 0 : 150,
    efl_url:    `https://powertochoose.org/en/plans/efl/${providers[i].slug}-${zip}`,
  }));
}

// â”€â”€â”€ MAIN SEARCH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function runSearch() {
  const zip = document.getElementById('zip-input').value.trim();
  if (zip.length !== 5) { showToast('âš ï¸ Enter a 5-digit ZIP'); return; }

  const tdu      = getTDU(zip);
  const city     = getCity(zip);
  const polrRate = POLR_RATES[tdu] || 14.2;
  const usage    = parseInt(localStorage.getItem('ww_usage') || '1000');

  // Show searching state
  document.getElementById('savings-result').style.display = 'none';
  document.getElementById('tip-jar').style.display        = 'none';
  document.getElementById('tip-thanks').style.display     = 'none';
  const overlay = document.getElementById('searching-overlay');
  overlay.style.display = 'block';
  document.getElementById('searching-zip-label').textContent = `Scanning ${zip}â€¦`;

  // Animate plan count
  let n = 0;
  const planCountEl = document.getElementById('searching-count');
  const countInterval = setInterval(() => {
    n = Math.min(n + Math.floor(Math.random()*6)+3, 42);
    planCountEl.textContent = `Comparing ${n} plans from all providers`;
  }, 120);

  // Simulate fetch (replace with real Supabase/API call)
  await new Promise(r => setTimeout(r, 2000 + Math.random()*600));
  clearInterval(countInterval);

  // â”€â”€ REAL SUPABASE QUERY (uncomment when DB is populated) â”€â”€
  // let plans = [];
  // if (APP.supabase) {
  //   const { data } = await APP.supabase
  //     .from('v_top3_plans_by_zip')
  //     .select('*')
  //     .eq('zip', zip)
  //     .order('effective_rate', { ascending: true })
  //     .limit(3);
  //   plans = data || [];
  // }
  // For now, generate mock data:
  const bestRate = polrRate - (3.5 + Math.random()*1.5);
  const plans    = generateMockPlans(zip, bestRate);
  const annualSavings = Math.round((polrRate - bestRate) * usage * 12 / 100);

  // Store state
  APP.currentZip  = zip;
  APP.currentData = { zip, city, tdu, polrRate, bestRate, annualSavings, plans, usage };
  saveSearchHistory(zip, city, annualSavings);

  // Hide searching, show results
  overlay.style.display = 'none';
  renderResults(APP.currentData);

  // Fire confetti + show tip jar after delay
  fireConfetti();
  setTimeout(() => {
    document.getElementById('tip-jar').style.display = 'block';
    document.getElementById('tip-savings-amount').textContent = `$${annualSavings} in savings`;
    document.getElementById('tip-jar').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  }, 1300);
}

function renderResults(data) {
  const { zip, city, tdu, polrRate, bestRate, annualSavings, plans } = data;

  document.getElementById('polr-rate-label').textContent     = `${polrRate.toFixed(1)}Â¢/kWh`;
  document.getElementById('savings-number').textContent      = `$${annualSavings.toLocaleString()}`;
  document.getElementById('best-rate-label').textContent     = `${bestRate.toFixed(1)}Â¢`;
  document.getElementById('your-rate-label').textContent     = `${polrRate.toFixed(1)}Â¢`;
  document.getElementById('savings-location-label').textContent = `ZIP ${zip} Â· ${city}, TX Â· ${tdu} territory`;

  // Render plan cards
  const container = document.getElementById('plan-cards-container');
  container.innerHTML = plans.map(p => `
    <div class="plan-card">
      <div class="plan-rank ${p.rank===1?'gold'}">
        #${p.rank}
      </div>
      <div class="plan-info">
        <div class="plan-provider">${p.provider}</div>
        <div class="plan-name">${p.name}</div>
        <div class="plan-tags">
          <span class="tag">${p.term} mo</span>
          ${p.green ? '<span class="tag green">ğŸŒ± Renewable</span>' : ''}
          ${p.cancel_fee === 0 ? '<span class="tag">No cancel fee</span>' : `<span class="tag">$${p.cancel_fee} cancel fee</span>`}
        </div>
        <a href="${p.efl_url}" target="_blank" class="efl-link">ğŸ“„ Download EFL â†’</a>
      </div>
      <div class="plan-rate-col">
        <div class="plan-rate">${p.rate}Â¢</div>
        <div class="plan-rate-sub">per kWh</div>
      </div>
    </div>
  `).join('');

  document.getElementById('savings-result').style.display = 'block';
  document.getElementById('savings-result').scrollIntoView({ behavior: 'smooth', block: 'start' });

  // Update history panel
  document.getElementById('history-zip-label').textContent = `ZIP ${zip} Â· ${city}`;
  renderHistory(data);
}

// â”€â”€â”€ HISTORY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function saveSearchHistory(zip, city, savings) {
  let history = JSON.parse(localStorage.getItem('ww_history') || '[]');
  history = history.filter(h => h.zip !== zip);
  history.unshift({ zip, city, savings, date: new Date().toLocaleDateString() });
  history = history.slice(0, 10);
  localStorage.setItem('ww_history', JSON.stringify(history));
  renderSavedZips();
}

function renderSavedZips() {
  const history = JSON.parse(localStorage.getItem('ww_history') || '[]');
  const el = document.getElementById('saved-zips-list');
  if (!history.length) {
    el.innerHTML = '<div class="empty-state" style="padding:20px 0"><span class="text-sub">Your searched ZIPs appear here</span></div>';
    return;
  }
  el.innerHTML = history.map(h => `
    <div class="flex-between" style="padding:12px 0;border-bottom:1px solid var(--tx-border);cursor:pointer"
      onclick="document.getElementById('zip-input').value='${h.zip}';switchTab('search');runSearch()">
      <div>
        <div class="bold">${h.zip} Â· ${h.city}</div>
        <div class="text-sub">${h.date}</div>
      </div>
      <div class="text-amber bold">Save $${h.savings}/yr</div>
    </div>
  `).join('');
}

function renderHistory(data) {
  // Generate mock 7-day history for the chart
  const rows = [];
  for (let i = 6; i >= 0; i--) {
    const d    = new Date(); d.setDate(d.getDate() - i);
    const rate = (data.bestRate + (Math.random()-0.5)*0.4).toFixed(2);
    rows.push({ date: d.toLocaleDateString('en-US',{month:'short',day:'numeric'}), rate });
  }
  document.getElementById('history-content').innerHTML = `
    <table class="rate-table">
      <thead><tr><th>Date</th><th>Best Rate</th><th>POLR Rate</th><th>Savings</th></tr></thead>
      <tbody>
        ${rows.map(r => `
          <tr>
            <td>${r.date}</td>
            <td class="rate-val">${r.rate}Â¢</td>
            <td style="color:var(--tx-red)">${data.polrRate.toFixed(1)}Â¢</td>
            <td class="text-green">$${Math.round((data.polrRate - parseFloat(r.rate)) * data.usage * 12 / 100)}/yr</td>
          </tr>
        `).join('')}
      </tbody>
    </table>
  `;
}

// â”€â”€â”€ CONFETTI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function fireConfetti() {
  const colors = ['#F59E0B','#EA580C','#FCD34D','#10B981'];
  function shoot(ratio, opts) {
    confetti({ particleCount: Math.floor(160*ratio), spread:60, origin:{y:0.55}, colors, ...opts });
  }
  shoot(0.25, { spread:26, startVelocity:55 });
  shoot(0.20, { spread:60 });
  shoot(0.35, { spread:100, decay:0.91, scalar:0.8 });
  shoot(0.10, { spread:120, startVelocity:25 });
}

// â”€â”€â”€ TIP LOGIC â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function handleTip(tier, amount) {
  // Log tip attempt to Supabase
  if (APP.supabase && APP.currentData) {
    APP.supabase.from('tips').insert({
      zip: APP.currentData.zip,
      annual_savings: APP.currentData.annualSavings,
      tier_label: tier,
      amount_usd: amount,
      status: 'pending',
    }).then(({ error }) => { if (error) console.warn('Tip log error', error); });
  }

  // Open payment link (replace with your Stripe link)
  const stripeLinks = {
    small_drip:    'https://buy.stripe.com/test_small',
    coffee_pastry: 'https://buy.stripe.com/test_medium',
    energy_hero:   'https://buy.stripe.com/test_large',
  };
  // For demo, skip payment and show thanks
  // window.open(stripeLinks[tier], '_blank');

  const msgs = {
    small_drip:    "That covers one day of server time. Every bit helps â€” thank you!",
    coffee_pastry: "That covers a full week online. You're a real one. Thank you!",
    energy_hero:   "Texas-sized generosity! That covers almost a month of hosting. You're a legend.",
  };
  document.getElementById('tip-jar').style.display    = 'none';
  document.getElementById('tip-thanks').style.display = 'block';
  document.getElementById('thanks-message').textContent = msgs[tier];
  confetti({ particleCount: 80, spread: 60, origin: { y: 0.8 }, colors: ['#10B981','#FCD34D','#F59E0B'] });
  showToast(`â˜• Thank you! $${amount} received`);
}

function dismissTip() {
  document.getElementById('tip-jar').style.display = 'none';
  showToast('ğŸ’¡ Come back anytime you need to compare rates');
}

// â”€â”€â”€ ALERTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function saveAlert() {
  const zip       = document.getElementById('alert-zip').value.trim();
  const threshold = parseFloat(document.getElementById('alert-threshold').value);
  const email     = document.getElementById('alert-email').value.trim();
  if (zip.length !== 5) { showToast('âš ï¸ Enter a valid ZIP'); return; }
  if (!threshold || threshold < 5) { showToast('âš ï¸ Enter a valid rate threshold'); return; }
  if (!email.includes('@')) { showToast('âš ï¸ Enter a valid email'); return; }

  const alert = { zip, threshold, email, created: new Date().toLocaleDateString(), id: Date.now() };
  let alerts = JSON.parse(localStorage.getItem('ww_alerts') || '[]');
  alerts.push(alert);
  localStorage.setItem('ww_alerts', JSON.stringify(alerts));

  // Save to Supabase if connected
  if (APP.supabase) {
    APP.supabase.from('rate_alerts').insert({ zip, threshold_rate: threshold, email, is_active: true })
      .then(({ error }) => { if (error) console.warn('Alert save error', error); });
  }

  renderAlerts();
  showToast(`ğŸ”” Alert set for ZIP ${zip} below ${threshold}Â¢`);
  document.getElementById('alert-zip').value = '';
  document.getElementById('alert-threshold').value = '';
  document.getElementById('alert-email').value = '';
}

function renderAlerts() {
  const alerts = JSON.parse(localStorage.getItem('ww_alerts') || '[]');
  const el = document.getElementById('alerts-list');
  if (!alerts.length) {
    el.innerHTML = '<div class="empty-state" style="padding:10px 0"><span class="text-sub">No alerts set yet</span></div>';
    return;
  }
  el.innerHTML = alerts.map(a => `
    <div class="flex-between" style="padding:12px 0;border-bottom:1px solid var(--tx-border)">
      <div>
        <div class="bold">ZIP ${a.zip}</div>
        <div class="text-sub">Alert when below <span class="text-amber">${a.threshold}Â¢/kWh</span></div>
        <div class="text-sub">${a.email}</div>
      </div>
      <button class="btn btn-outline btn-sm" style="color:var(--tx-red);border-color:rgba(239,68,68,0.3)"
        onclick="deleteAlert(${a.id})">ğŸ—‘ï¸</button>
    </div>
  `).join('');
}

function deleteAlert(id) {
  let alerts = JSON.parse(localStorage.getItem('ww_alerts') || '[]');
  alerts = alerts.filter(a => a.id !== id);
  localStorage.setItem('ww_alerts', JSON.stringify(alerts));
  renderAlerts();
  showToast('Alert deleted');
}

// â”€â”€â”€ SHARING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function shareNeighborhood() {
  const zip  = APP.currentZip || '75024';
  const city = APP.currentData?.city || 'your area';
  const save = APP.currentData?.annualSavings || 500;
  const rate = APP.currentData?.bestRate?.toFixed(1) || '9.4';
  const url  = `https://wattwisegratuity.com/${zip}`;
  const text = `ğŸ“£ ${city} neighbors â€” are you overpaying for electricity?\n\nI found a free tool that compares every energy plan in our ZIP code. Best rate right now: ${rate}Â¢/kWh vs the default ${POLR_RATES[getTDU(zip)] || 14.2}Â¢ â€” that's ~$${save}/year in savings.\n\nNo email. No ads. No kickbacks.\nğŸ‘‰ ${url}`;
  if (navigator.share) {
    navigator.share({ title: 'WattWise â€” Texas Energy Savings', text, url });
  } else {
    navigator.clipboard.writeText(text).then(() => showToast('âœ… Share text copied!'));
  }
}

function copyShareText() {
  const zip  = APP.currentZip || 'your ZIP';
  const city = APP.currentData?.city || 'your city';
  const save = APP.currentData?.annualSavings || 500;
  const text = `Hey neighbors â€” I found a free tool that shows you if you're overpaying for electricity in ${city}.\n\nNo email required, no ads, the developer doesn't take kickbacks from energy companies. Just type your ZIP and see how much you could save.\n\nI saved ~$${save}/year.\nğŸ‘‰ https://wattwisegratuity.com/${zip}`;
  navigator.clipboard.writeText(text).then(() => showToast('âœ… Neighborly message copied!'));
}

// â”€â”€â”€ PREFERENCES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function savePrefs() {
  const usage = parseInt(document.getElementById('pref-usage').value) || 1000;
  const zip   = document.getElementById('pref-zip').value.trim();
  localStorage.setItem('ww_usage', usage);
  localStorage.setItem('ww_default_zip', zip);
  showToast('âœ… Preferences saved');
}

function loadPrefs() {
  const usage = localStorage.getItem('ww_usage') || '1000';
  const zip   = localStorage.getItem('ww_default_zip') || '';
  document.getElementById('pref-usage').value = usage;
  document.getElementById('pref-zip').value   = zip;
  if (zip) document.getElementById('zip-input').value = zip;
}

// â”€â”€â”€ EXPORT / CLEAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function exportData() {
  const data = {
    history: JSON.parse(localStorage.getItem('ww_history') || '[]'),
    alerts:  JSON.parse(localStorage.getItem('ww_alerts')  || '[]'),
    prefs: {
      usage:      localStorage.getItem('ww_usage'),
      defaultZip: localStorage.getItem('ww_default_zip'),
    },
    exportedAt: new Date().toISOString(),
  };
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const a    = document.createElement('a');
  a.href     = URL.createObjectURL(blob);
  a.download = `wattwise-export-${Date.now()}.json`;
  a.click();
}

function clearData() {
  if (!confirm('Clear all local data? This cannot be undone.')) return;
  ['ww_history','ww_alerts','ww_usage','ww_default_zip'].forEach(k => localStorage.removeItem(k));
  showToast('ğŸ—‘ï¸ Local data cleared');
  renderSavedZips();
  renderAlerts();
}

// â”€â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showToast(msg, duration = 2800) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), duration);
}

// â”€â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener('DOMContentLoaded', () => {
  initSupabase();
  loadPrefs();
  renderSavedZips();
  renderAlerts();

  // Online/offline indicator
  function updateStatus() {
    const online = navigator.onLine;
    document.getElementById('status-dot').className   = `status-dot ${online?'online':'offline'}`;
    document.getElementById('status-text').textContent = online ? 'Texas Live' : 'Offline';
  }
  window.addEventListener('online',  updateStatus);
  window.addEventListener('offline', updateStatus);
  updateStatus();
});

</script>
</body>
</html>
